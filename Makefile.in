px-objs = pxd.o dev.o iov_iter.o px_version.o kiolib.o pxd_bio_blkmq.o pxd_fastpath.o
obj-m = px.o

KBUILD_CPPFLAGS := -D__KERNEL__
KVERSION=$(shell uname -r)

ifndef KERNELPATH
ifeq ($(shell test -d "/usr/src/linux-headers-$(KVERSION)"; echo $$?),0)
     KERNELPATH=/usr/src/linux-headers-$(KVERSION)
else
     KERNELPATH=/usr/src/kernels/$(KVERSION)
endif
endif

# Check for version in KERNELPATH version release file
ifeq ($(shell test -f "$(KERNELPATH)/include/generated/utsrelease.h"; echo $$?),0)
CHK_KVER=$(shell sed -n 's/.* *UTS_RELEASE *"\(.*\)".*/\1/p' $(KERNELPATH)/include/generated/utsrelease.h)
endif

# If no KERNELPATH version found or extract fails use $(KVERSION)
ifeq ($(CHK_KVER),)
CHK_KVER=$(KVERSION)
endif

ifeq ($(shell test -d $(KERNELPATH); echo $$?),1)
$(error Kernel path: $(KERNELPATH)  directory does not exist.)
endif

MINKVER=3.10
BLKMQ_MINKVER=4.18
KERNELVER=$(shell echo $(CHK_KVER) | /bin/sed 's/\([0-9].[0-9]\+\).*/\1/g')

majorfn=$(shell echo "$1" | /bin/sed 's/\(.*\)\.\(.*\)/\1/g')
minorfn=$(shell echo "$1" | /bin/sed 's/\(.*\)\.\(.*\)/\2/g')

verlater=$(shell test "$1" -gt "$2"; echo $$?)
versameorlater=$(shell test "$1" -ge "$2"; echo $$?)
versame=$(shell test "$1" -eq "$2"; echo $$?)

minver_major=$(call majorfn, ${MINKVER})
minver_minor=$(call minorfn, ${MINKVER})

blkmq_major=$(call majorfn, ${BLKMQ_MINKVER})
blkmq_minor=$(call minorfn, ${BLKMQ_MINKVER})

kmajor=$(call majorfn, ${KERNELVER})
kminor=$(call minorfn, ${KERNELVER})

#FPATH_MINKVER=${kmajor}.${kminor}

#blkmq mode has version check for fastpath (default, enabled)
PXDEFINES := -D__PXKERNEL__ -D__PXD_BIO_BLKMQ__
FPATH_MINKVER=4.12

fp_major=$(call majorfn, ${FPATH_MINKVER})
fp_minor=$(call minorfn, ${FPATH_MINKVER})


## min kernel version checks
ifeq ($(call verlater,${minver_major},${kmajor}),0)
$(error Kernel version error: Build kernel version must be >= $(MINKVER).)
else
ifeq ($(call versame,${minver_major},${kmajor}),0)
ifeq ($(call verlater,${minver_minor},${kminor}),0)
$(error Kernel version error: Build kernel version must be >= $(MINKVER).)
endif
endif
endif

## fastpath checks
ifeq ($(call verlater,${kmajor},${fp_major}),0)
PXDEFINES += -D__PX_FASTPATH__
$(info Kernel version ${KERNELVER} supports fastpath.)
else
ifeq ($(call versame,${kmajor},${fp_major}),0)
ifeq ($(call versameorlater,${kminor},${fp_minor}),0)
PXDEFINES += -D__PX_FASTPATH__
$(info Kernel version ${KERNELVER} supports fastpath.)
endif
endif
endif

## blkmq checks
ifeq ($(call verlater,${kmajor},${blkmq_major}),0)
PXDEFINES += -D__PX_BLKMQ__
$(info Kernel version ${KERNELVER} supports blkmq driver model.)
else
ifeq ($(call versame,${kmajor},${blkmq_major}),0)
ifeq ($(call versameorlater,${kminor},${blkmq_minor}),0)
PXDEFINES += -D__PX_BLKMQ__
$(info Kernel version ${KERNELVER} supports blkmq driver model.)
endif
endif
endif

# EL8-9 Specific kernel checks, uapi version.h file has RHEL specific defines maybe can use.
ifeq ($(shell echo "$(CHK_KVER)" | grep -Eq '.*\.el[8-9].*\.x86_64'; echo $$?),0)
PXDEFINES += -D__PX_BLKMQ__ -D__EL8__
endif

# CentOS Stream 9-10 Specific kernel checks
ifeq ($(shell echo "$(CHK_KVER)" | grep -Eq '.*\.el(9|10)\.x86_64'; echo $$?),0)
PXDEFINES += -D__EL9_STREAM__
endif

# ELRepo 9-10 Specific kernel checks
ifeq ($(shell echo "$(CHK_KVER)" | grep -Eq '.*\.el(9|10)\.elrepo\.x86_64'; echo $$?),0)
PXDEFINES += -D__ELREPO9__
endif

# Oracle UEK Specific kernel checks
ifeq ($(shell echo "$(CHK_KVER)" | grep -Eq '.*\.el[8-9]uek\.x86_64'; echo $$?),0)
PXDEFINES += -D__ORACLE_UEK__
endif

# Detect SUSE Linux Micro 6.0 or 6.1 inside PX container
ifeq ($(shell test -f "/host-os-release"; echo $$?),0)   # inside PX container
ifeq ($(shell cat "/host-os-release" | grep -E -q "SUSE Linux Micro 6\.[01]"; echo $$?),0)
PXDEFINES += -D__SLE_MICRO_GTE_6_0__
endif
endif

# Detect SUSE Linux Micro 6.0 or 6.1 on host
ifeq ($(shell test -f "/etc/os-release"; echo $$?),0)   # on host
ifeq ($(shell cat "/etc/os-release" | grep -E -q "SUSE Linux Micro 6\.[01]"; echo $$?),0)
PXDEFINES += -D__SLE_MICRO_GTE_6_0__
endif
endif

# Extract CONFIG_SUSE_PATCHLEVEL from kernel config if this is a SUSE kernel
# Try multiple locations for the kernel config file
ifeq ($(shell test -f "/boot/config-$(KVERSION)"; echo $$?),0)
    CONFIG_SUSE_PATCHLEVEL := $(shell grep "^CONFIG_SUSE_PATCHLEVEL=" /boot/config-$(KVERSION) 2>/dev/null | cut -d= -f2)
else ifeq ($(shell test -f "$(KERNELPATH)/.config"; echo $$?),0)
    CONFIG_SUSE_PATCHLEVEL := $(shell grep "^CONFIG_SUSE_PATCHLEVEL=" $(KERNELPATH)/.config 2>/dev/null | cut -d= -f2)
else ifeq ($(shell test -f "/proc/config.gz"; echo $$?),0)
    CONFIG_SUSE_PATCHLEVEL := $(shell zcat /proc/config.gz 2>/dev/null | grep "^CONFIG_SUSE_PATCHLEVEL=" | cut -d= -f2)
endif

ifdef CONFIG_SUSE_PATCHLEVEL
ifeq ($(shell test $(CONFIG_SUSE_PATCHLEVEL) -eq 5; echo $$?),0)
PXDEFINES += -D__SUSE_EQ_SP5__
endif

ifeq ($(shell test $(CONFIG_SUSE_PATCHLEVEL) -ge 6; echo $$?),0)
PXDEFINES += -D__SUSE_GTE_SP6__
endif
endif

ifdef KERNELOTHER
KERNELOTHEROPT=O=$(KERNELOTHER)
endif

MAJOR=$(shell echo $(CHK_KVER) | awk -F. '{print $$1}')
MINOR=$(shell echo $(CHK_KVER) | awk -F. '{print $$2}')
PATCH=$(shell echo $(CHK_KVER) | awk -F. '{print $$3}' | awk -F- '{print $$1}')
export REVISION=$(shell echo $(CHK_KVER) | awk -F. '{print $$3}' |  awk -F- '{print $$2}')
export VERSION=$(MAJOR).$(MINOR).$(PATCH)

# Extract SUSE build version from kernel version string and detect blk_mode_t support
# Only process if CONFIG_SUSE_PATCHLEVEL is defined (i.e., this is a SUSE kernel)
ifdef CONFIG_SUSE_PATCHLEVEL
    SUSE_BUILD=$(shell echo $(CHK_KVER) | awk -F- '{if (NF>1) print $$2}' | awk -F. '{print $$1}')
    SUSE_MINOR=$(shell echo $(CHK_KVER) | awk -F- '{if (NF>1) print $$2}' | awk -F. '{print $$2}')

    # Detect SUSE kernels that use blk_mode_t (new API) vs fmode_t (old API)
    # Logic: 150600.5+.x -> blk_mode_t (new), 150600.1-4.x -> fmode_t (old)

	# Detect SUSE kernels that use GENHD_FL_NO_PART_SCAN
	# Logic: 150500.22+.x -> GENHD_FL_NO_PART_SCAN (new), 150500.1-21.x -> GENHD_FL_EXT_DEVT (old)
    ifneq ($(SUSE_BUILD),)
        SUSE_HAS_BLK_MODE_T := 0

        ifeq ($(SUSE_BUILD),150600)
            ifeq ($(shell test $(SUSE_MINOR) -ge 5; echo $$?),0)
                SUSE_HAS_BLK_MODE_T := 1
            endif
        else ifeq ($(shell test $(SUSE_BUILD) -gt 150600; echo $$?),0)
            # Newer SUSE versions (e.g., 160000+) use blk_mode_t
            SUSE_HAS_BLK_MODE_T := 1
        endif

        ifeq ($(SUSE_HAS_BLK_MODE_T),1)
            PXDEFINES += -D__SUSE_HAS_BLK_MODE_T__
        endif

		SUSE_HAS_NO_PART_SCAN := 0
		ifeq ($(SUSE_BUILD),150500)
			ifeq ($(shell test $(SUSE_MINOR) -ge 22; echo $$?),0)
				SUSE_HAS_NO_PART_SCAN := 1
			endif
		else ifeq ($(shell test $(SUSE_BUILD) -gt 150500; echo $$?),0)
			# Newer SUSE versions (e.g., 150600+) use GENHD_FL_NO_PART_SCAN
			SUSE_HAS_NO_PART_SCAN := 1
		endif

		ifeq ($(SUSE_HAS_NO_PART_SCAN),1)
			PXDEFINES += -D__SUSE_HAS_NO_PART_SCAN__
		endif
    endif
endif
export KERNELPATH
export OUTPATH
ccflags-y := $(ADDCCFLAGS) -Wframe-larger-than=2048 -Werror -I$(src) $(KBUILD_CPPFLAGS) $(PXDEFINES)

# EL8-9 Specific kernel checks - this check also exists above - JAR?
ifeq ($(shell echo "$(CHK_KVER)" | grep -Eq '.*\.el[8-9].*\.x86_64'; echo $$?),0)
PXDEFINES += -D__PX_BLKMQ__ -D__EL8__
else
# 5.x kernel checks
ifeq ($(shell test "$(MAJOR)" = "5"; echo $$?),0)
PXDEFINES += -D__PX_BLKMQ__
endif
endif

ifdef FORCE_CONTAINER_CC
FORCE_CC=CC=$(FORCE_CONTAINER_CC)
endif

ccflags-y := $(ADDCCFLAGS) -Wframe-larger-than=2048 -Werror -I$(src) $(KBUILD_CPPFLAGS) $(PXDEFINES)

all: px_version.c
	make $(FORCE_CC) -C $(KERNELPATH) $(KERNELOTHEROPT) M=$(CURDIR) modules

insert: all
	insmod px.ko $(PXD_NUM_CONTEXT_EXPORTED)

clean:
	make -C $(KERNELPATH) $(KERNELOTHEROPT) M=$(CURDIR) clean

install:
	make V=1 -C $(KERNELPATH) $(KERNELOTHEROPT) M=$(CURDIR) modules_install

test_clean:
	@/bin/rm -f test/pxd_test

pxd_test: test/pxd_test.cc test/pxd_fastpath_test.cc
	@echo "Building Tests ..."
	g++ -I. -std=c++11 test/pxd_test.cc test/pxd_fastpath_test.cc -lgtest -lboost_iostreams -lpthread -o test/pxd_test

rpm:
	@cd rpm && ./buildrpm.sh

docker-build-dev:
	docker build -t portworx/px-fuse:dev -f Dockerfile .

docker-build: docker-build-dev
	docker run --privileged \
	-v /usr/src/:/usr/src  \
	-v $(shell pwd):/home/px-fuse \
	portworx/px-fuse:dev make

px_version.c:
	@COMMIT_HASH=$$(git rev-parse HEAD); \
	if [ ! -f .version ]; then \
		echo "Error: .version file not found"; \
		exit 1; \
	fi; \
	BRANCH_NAME=$$(cat .version | tr -d '\n'); \
	echo "const char *gitversion = \"$$BRANCH_NAME:$$COMMIT_HASH\";" > $@

distclean: clean
	@/bin/rm -f  config.* Makefile
	@/bin/rm -f test/pxd_test
